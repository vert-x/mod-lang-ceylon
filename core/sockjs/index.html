<!DOCTYPE html><html><head><meta charset='UTF-8'/>
<title>Package [io, vertx, ceylon, core, sockjs]</title><link href='../.resources/favicon.ico' rel='shortcut icon'/>
<link href='../.resources/shCore.css' rel='stylesheet' type='text/css'/>
<link href='../.resources/shThemeDefault.css' rel='stylesheet' type='text/css'/>
<link href='../.resources/bootstrap.min.css' rel='stylesheet' type='text/css'/>
<link href='../.resources/ceylondoc.css' rel='stylesheet' type='text/css'/>
<link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro|Inconsolata' rel='stylesheet' type='text/css'/>
</head><body><div class='navbar navbar-inverse navbar-static-top'><div class='navbar-inner'><a class='module-header' href='../index.html'><i class='module-logo'></i><span class='module-label'>module</span><span class='module-name'>io.vertx.ceylon.core</span><span class='module-version'>0.4.0</span></a><ul class='nav pull-right'><li class='divider-vertical' /><li><a class='expand-all' href='#' title='Expand All [Shortcut: + plus]'><i class='icon-expand-all'></i></a></li><li><a class='collapse-all' href='#' title='Collapse All [Shortcut: - minus]'><i class='icon-collapse-all'></i></a></li><li id='infoDropdown' class='dropdown'><a href='#' title='Show keyboard shortcuts [Shortcut: ?]' role='button' class='dropdown-toggle' data-toggle='dropdown'><i class='icon-info'></i></a><ul id='info-dropdown-panel' class='dropdown-menu'><h4>Keyboard Shortcuts</h4><li class='divider'></li><div class='row-fluid'><div id='info-common-shortcuts' class='span6'><div id='f'><span class='key badge'>f</span><span class='info muted'>Open filter by tags</span></div><div id='s'><span class='key badge'>s</span><span class='info muted'>Open search page</span></div><div id='?'><span class='key badge'>?</span><span class='info muted'>Open this information panel</span></div></div><div id='info-expand-collapse-shortcuts' class='span6'><div id='+'><span class='key badge'>+</span><span class='info muted'>Expand all</span></div><div id='-'><span class='key badge'>-</span><span class='info muted'>Collapse all</span></div></div></div><li class='divider'></li><div class='row-fluid'><div id='info-doc-shortcuts' class='span6'><h5>Documentation:</h5><div id='o'><span class='key badge'>o</span><span class='info muted'>Jump to module documentation</span></div><div id='p'><span class='key badge'>p</span><span class='info muted'>Jump to package documentation</span></div><div id='l'><span class='key badge'>l</span><span class='info muted'>Jump to aliases</span></div><div id='n'><span class='key badge'>n</span><span class='info muted'>Jump to annotations</span></div><div id='z'><span class='key badge'>z</span><span class='info muted'>Jump to initializer</span></div><div id='v'><span class='key badge'>v</span><span class='info muted'>Jump to values</span></div><div id='f'><span class='key badge'>f</span><span class='info muted'>Jump to functions</span></div><div id='i'><span class='key badge'>i</span><span class='info muted'>Jump to interfaces</span></div><div id='c'><span class='key badge'>c</span><span class='info muted'>Jump to classes</span></div><div id='e'><span class='key badge'>e</span><span class='info muted'>Jump to exceptions</span></div></div><div id='info-search-shortcuts' class='span6'><h5>Search page:</h5><div id='enter'><span class='key badge'>enter</span><span class='info muted'>Jump to selected declaration</span></div><div id='esc'><span class='key badge'>esc</span><span class='info muted'>Clear search query/Go to overview</span></div><div id='up'><span class='key badge'>up</span><span class='info muted'>Move selection up</span></div><div id='down'><span class='key badge'>down</span><span class='info muted'>Move selection down</span></div></div></div></ul></li></ul><ul class='nav pull-right'><li class='divider-vertical' /><li><a href='../search.html' title='Search this module [Shortcut: S]'><i class='icon-search'></i>Search</a></li></ul><ul class='nav pull-right'><li class='divider-vertical' /><li id='filterDropdown' class='dropdown'><a href='#' title='Filter declarations by tags [Shortcut: F]' role='button' class='dropdown-toggle' data-toggle='dropdown'><i class='icon-filter'></i>Filter <span id='filterDropdownLinkInfo'></span> <b class='caret'></b></a><ul id='filterDropdownPanel' class='dropdown-menu'><h4 id='filterDropdownPanelInfo'>Filter declarations by tags</h4><li class='divider'></li><div id='filterDropdownPanelTags'></div><li class='divider'></li><div id='filterActions'><a id='filterActionAll'>All</a><a id='filterActionNone'>None</a><a id='filterActionMore'>Show more</a></div></ul></li></ul></div></div><div class='sub-navbar'><div class='sub-navbar-inner'><span class='sub-navbar-label'>package</span><i class='icon-package'></i><span class='sub-navbar-name'><a class='link' href='../index.html#section-package' title='Go to package io.vertx.ceylon.core'>io.vertx.ceylon.core</a>.<a class='link-custom-text' href='../sockjs/index.html' title='Go to package io.vertx.ceylon.core.sockjs'>sockjs</a></span></div><div class='sub-navbar-menu'><a href='../index.html'><span title='Jump to module documentation [Shortcut: O]'><span class='accesskey'>O</span>verview</span></a><a href='#section-interfaces'><span title='Jump to interfaces [Shortcut: I]'><span class='accesskey'>I</span>nterfaces</span></a><a href='#section-classes'><span title='Jump to classes [Shortcut: C]'><span class='accesskey'>C</span>lasses</span></a></div></div><div class='container-fluid'><div class='package-description'><div class='doc'><h1>SockJS</h1>
<p>WebSockets are a new technology, and many users are still using browsers that do not support them, or which
support older, pre-final, versions.</p>
<p>Moreover, WebSockets do not work well with many corporate proxies. This means that's it's not possible
to guarantee a WebSockets connection is going to succeed for every user.</p>
<p>Enter SockJS.</p>
<p>SockJS is a client side JavaScript library and protocol which provides a simple WebSocket-like
interface to the client side JavaScript developer irrespective of whether the actual browser or network
will allow real WebSockets.</p>
<p>It does this by supporting various different transports between browser and server, and choosing one at
runtime according to browser and network capabilities. All this is transparent to you - you are simply
presented with the WebSocket-like interface which <em>just works</em>.</p>
<p>Please see the <a href="https://github.com/sockjs/sockjs-client">SockJS website</a> for more information.</p>
<h2>SockJS Server</h2>
<p>Vert.x provides a complete server side SockJS implementation.</p>
<p>This enables Vert.x to be used for modern, so-called real-time (this is the modern meaning of real-time,
not to be confused by the more formal pre-existing definitions of soft and hard real-time systems) web
applications that push data to and from rich client-side JavaScript applications, without having to
worry about the details of the transport.</p>
<p>To create a SockJS server you simply create a HTTP server as normal and then call the createSockJSServer
method of your vertx instance passing in the Http server:</p>
<pre>value httpServer = vertx.createHttpServer();
value sockJSServer = vertx.createSockJSServer(httpServer);
</pre>
<p>Each SockJS server can host multiple <em>applications</em>.</p>
<p>Each application is defined by some configuration, and provides a handler which gets called when
incoming SockJS connections arrive at the server.</p>
<p>For example, to create a SockJS echo application:</p>
<pre>value httpServer = vertx.createHttpServer();

value sockJSServer = vertx.createSockJSServer(httpServer);

Object config = new Object { "prefix"-&gt;"/echo" };

sockJSServer.installApp(config, (SockJSSocket sock) =&gt; Pump.createPump(sock, sock).start());

httpServer.listen(8080);
</pre>
<p>The configuration is an instance of <span title='ceylon.json::Object'>ceylon.json::Object</span>, which takes the following fields:</p>
<ul>
<li><code>prefix</code>: A url prefix for the application. All http requests whose paths begins with selected prefix
will be handled by the application. This property is mandatory.</li>
<li><code>insert_JSESSIONID</code>: Some hosting providers enable sticky sessions only to requests that have
JSESSIONID cookie set. This setting controls if the server should set this cookie to a dummy value.
By default setting JSESSIONID cookie is enabled. More sophisticated beaviour can be achieved by supplying
a function.</li>
<li><code>session_timeout</code>: The server sends a <code>close</code> event when a client receiving connection have not been seen
for a while. This delay is configured by this setting. By default the <code>close</code> event will be emitted when
a receiving connection wasn't seen for 5 seconds.</li>
<li><code>heartbeat_period</code>: In order to keep proxies and load balancers from closing long running http requests
we need to pretend that the connection is active and send a heartbeat packet once in a while.
This setting controls how often this is done. By default a heartbeat packet is sent every 5 seconds.</li>
<li><code>max_bytes_streaming</code>: Most streaming transports save responses on the client side and don't free
memory used by delivered messages. Such transports need to be garbage-collected once in a while.
`max_bytes_streaming sets a minimum number of bytes that can be send over a single http streaming request
before it will be closed. After that client needs to open new request. Setting this value to one effectively
disables streaming and will make streaming transports to behave like polling transports. The default
value is 128K.</li>
<li><code>library_url</code>: Transports which don't support cross-domain communication natively ('eventsource' to name one)
use an iframe trick. A simple page is served from the SockJS server (using its foreign domain) and is placed
in an invisible iframe. Code run from this iframe doesn't need to worry about cross-domain issues, as it's
being run from domain local to the SockJS server. This iframe also does need to load SockJS javascript
client library, and this option lets you specify its url (if you're unsure, point it to the latest minified
SockJS client release, this is the default). The default value is <code>http://cdn.sockjs.org/sockjs-0.3.4.min.js</code></li>
</ul>
<h2>Reading and writing data from a SockJS server</h2>
<p>The <a class='link' href='../sockjs/SockJSSocket.type.html' title='Go to io.vertx.ceylon.core.sockjs::SockJSSocket'>SockJSSocket</a> object passed into the SockJS handler provides access to <a class='link' href='../sockjs/SockJSSocket.type.html#readStream' title='Go to io.vertx.ceylon.core.sockjs::SockJSSocket.readStream'>SockJSSocket.readStream</a> and
<a class='link' href='../sockjs/SockJSSocket.type.html#writeStream' title='Go to io.vertx.ceylon.core.sockjs::SockJSSocket.writeStream'>SockJSSocket.writeStream</a> much like WebSocket. You can therefore use the standard API for reading and
writing to the SockJS socket or using it in pumps.</p>
<p>See the chapter on Streams and Pumps for more information.</p>
<h2>SockJS client</h2>
<p>For full information on using the SockJS client library please see the SockJS website. A simple example:</p>
<pre>&lt;script&gt;
  var sock = new SockJS('http://mydomain.com/my_prefix');

  sock.onopen = function() {
    console.log('open');
  };

  sock.onmessage = function(e) {
    console.log('message', e.data);
  };

  sock.onclose = function() {
    console.log('close');
  };
&lt;/script&gt;
</pre>
<p>As you can see the API is very similar to the WebSockets API.</p>
<h1>SockJS - EventBus Bridge</h1>
<h2>Setting up the Bridge</h2>
<p>By connecting up SockJS and the Vert.x event bus we create a distributed event bus which not only spans
multiple Vert.x instances on the server side, but can also include client side JavaScript running
in browsers.</p>
<p>We can therefore create a huge distributed bus encompassing many browsers and servers. The browsers don't
have to be connected to the same server as long as the servers are connected.</p>
<p>On the server side we have already discussed the event bus API.</p>
<p>We also provide a client side JavaScript library called <code>vertxbus.js</code> which provides the same event bus
API, but on the client side.</p>
<p>This library internally uses SockJS to send and receive data to a SockJS Vert.x server called the
SockJS bridge. It's the bridge's responsibility to bridge data between SockJS sockets and the event
bus on the server side.</p>
<p>Creating a Sock JS bridge is simple. You just call the `bridge method on the SockJS server.</p>
<p>You will also need to secure the bridge (see below).</p>
<p>The following example bridges the event bus to client side JavaScript:</p>
<pre>value server = vertx.createHttpServer();

value config = Object { "prefix"-&gt;"/eventbus" };

Array noPermitted = Array();
noPermitted.add(new JsonObject());

vertx.createSockJSServer(server).bridge(config, noPermitted, noPermitted);

server.listen(8080);
</pre>
<p>To let all messages through you can specify two JSON array with a single empty JSON object which will
match all messages.</p>
<p><em>Be very careful!</em></p>
<h2>Using the Event Bus from client side JavaScript</h2>
<p>Once you've set up a bridge, you can use the event bus from the client side as follows:</p>
<p>In your web page, you need to load the script <code>vertxbus.js</code>, then you can access the Vert.x event bus API.
Here's a rough idea of how to use it. For a full working examples, please consult the vert.x examples.</p>
<pre>&lt;script src="http://cdn.sockjs.org/sockjs-0.3.4.min.js"&gt;&lt;/script&gt;
&lt;script src='vertxbus.js'&gt;&lt;/script&gt;

&lt;script&gt;

  var eb = new vertx.EventBus('http://localhost:8080/eventbus');

  eb.onopen = function() {
    eb.registerHandler('some-address', function(message) {
      console.log('received a message: ' + JSON.stringify(message);
    });
    eb.send('some-address', {name: 'tim', age: 587});
  }

&lt;/script&gt;
</pre>
<p>You can find <code>vertxbus.js</code> in the client directory of the Vert.x distribution.</p>
<p>The first thing the example does is to create a instance of the event bus</p>
<pre>var eb = new vertx.EventBus('http://localhost:8080/eventbus');
</pre>
<p>The parameter to the constructor is the URI where to connect to the event bus. Since we create our
bridge with the prefix eventbus we will connect there.</p>
<p>You can't actually do anything with the bridge until it is opened. When it is open the <code>onopen</code> handler
will be called.</p>
<p>The client side event bus API for registering and unregistering handlers and for sending messages is
the same as the server side one. Please consult the chapter on the event bus for full information.</p>
<p><em>There is one more thing to do before getting this working, please read the following section&hellip;.</em></p>
<h2>Securing the Bridge</h2>
<p>If you started a bridge like in the above example without securing it, and attempted to send messages
through it you'd find that the messages mysteriously disappeared. What happened to them?</p>
<p>For most applications you probably don't want client side JavaScript being able to send just any message
to any verticle on the server side or to all other browsers.</p>
<p>For example, you may have a persistor verticle on the event bus which allows data to be accessed or
deleted. We don't want badly behaved or malicious clients being able to delete all the data in your
database! Also, we don't necessarily want any client to be able to listen in on any topic.</p>
<p>To deal with this, a SockJS bridge will, by default refuse to let through any messages. It's up to
you to tell the bridge what messages are ok for it to pass through. (There is an exception for
reply messages which are always allowed through).</p>
<p>In other words the bridge acts like a kind of firewall which has a default <em>deny-all</em> policy.</p>
<p>Configuring the bridge to tell it what messages it should pass through is easy. You pass in two Json
arrays that represent matches, as arguments to <code>bridge</code>.</p>
<p>The first array is the <code>inbound</code> list and represents the messages that you want to allow through
from the client to the server. The second array is the <code>outbound</code> list and represents the messages that
you want to allow through from the server to the client.</p>
<p>Each match can have up to three fields:</p>
<ul>
<li><code>address</code>: This represents the exact address the message is being sent to. If you want to filter
messages based on an exact address you use this field.</li>
<li><code>address_re</code>: This is a regular expression that will be matched against the address. If you want to
filter messages based on a regular expression you use this field. If the <code>address</code> field is
specified this field will be ignored.</li>
<li><code>match</code>: This allows you to filter messages based on their structure. Any fields in the match must
exist in the message with the same values for them to be passed. This currently only works with JSON messages.</li>
</ul>
<p>When a message arrives at the bridge, it will look through the available permitted entries.</p>
<ul>
<li>If an <code>address</code> field has been specified then the <code>address</code> must match exactly with the address of the message for it to be considered matched.</li>
<li>If an <code>address</code> field has not been specified and an <code>address_re</code> field has been specified then the
regular expression in <code>address_re</code> must match with the address of the message for it to be considered matched.</li>
<li>If a <code>match</code> field has been specified, then also the structure of the message must match.</li>
</ul>
<p>Here is an example:</p>
<pre>value server = vertx.createHttpServer();

value config = Object { "prefix"-&gt;"/echo" };

value inboundPermitted = new Array();

// Let through any messages sent to 'demo.orderMgr'
value inboundPermitted1 = JsonObject { "address"-&gt;"demo.orderMgr" };
inboundPermitted.add(inboundPermitted1);

// Allow calls to the address 'demo.persistor' as long as the messages
// have an action field with value 'find' and a collection field with value
// 'albums'
value inboundPermitted2 = Object {
  "address"-&gt;"demo.persistor",
  "match"-&gt; Object { "action"-&gt;"find", "collection"-&gt;"albums" }
};
inboundPermitted.add(inboundPermitted2);

// Allow through any message with a field `wibble` with value `foo`.
Object inboundPermitted3 = Object { "match"-&gt; Object { "wibble"-&gt;"foo" } };
inboundPermitted.add(inboundPermitted3);

value outboundPermitted = Array();

// Let through any messages coming from address 'ticker.mystock'
value outboundPermitted1 = Object { "address"-&gt;"ticker.mystock" };
outboundPermitted.add(outboundPermitted1);

// Let through any messages from addresses starting with "news." (e.g. news.europe, news.usa, etc)
value outboundPermitted2 = Object { "address_re"-&gt;"news\\..+" };
outboundPermitted.add(outboundPermitted2);

vertx.createSockJSBridge(server).bridge(config, inboundPermitted, outboundPermitted);

server.listen(8080);
</pre>
<h2>Messages that require authorisation</h2>
<p>The bridge can also refuse to let certain messages through if the user is not authorised.</p>
<p>To enable this you need to make sure an instance of the <code>vertx.auth-mgr</code> module is available on the
event bus. (Please see the modules manual for a full description of modules).</p>
<p>To tell the bridge that certain messages require authorisation before being passed, you add
the field <code>requires_auth</code> with the value of true in the match. The default value is <code>false</code>.
For example, the following match:</p>
<pre>{
  address : 'demo.persistor',
  match : {
    action : 'find',
    collection : 'albums'
  },
  requires_auth: true
}
</pre>
<p>This tells the bridge that any messages to save orders in the <code>orders</code> collection, will only be passed
if the user is successful authenticated (i.e. logged in ok) first.</p>
</div></div><table id='section-interfaces' class='table table-condensed table-bordered table-hover'><thead><tr class='table-header' title='Click for expand/collapse'><td colspan='2'><i class='icon-expand'></i>Interfaces</td></tr></thead><tbody><tr><td id='EventBusBridgeHook' nowrap><i class='icon-interface'></i><a class='link-discreet' href='../sockjs/EventBusBridgeHook.type.html'>EventBusBridgeHook</a></td><td><a class='link-one-self' title='Link to this declaration' href='../sockjs/index.html#EventBusBridgeHook'><i class='icon-link'></i></a><div class='signature'><span class='modifiers'>shared</span> <a class='link' href='../sockjs/EventBusBridgeHook.type.html' title='Go to io.vertx.ceylon.core.sockjs::EventBusBridgeHook'>EventBusBridgeHook</a></div><div class='description'><div class='doc section'><p>A hook that you can use to receive various events on the EventBusBridge.</p>
</div></div></td></tr></tbody></table><table id='section-classes' class='table table-condensed table-bordered table-hover'><thead><tr class='table-header' title='Click for expand/collapse'><td colspan='2'><i class='icon-expand'></i>Classes</td></tr></thead><tbody><tr><td id='SockJSServer' nowrap><i class='icon-class'></i><a class='link-discreet' href='../sockjs/SockJSServer.type.html'>SockJSServer</a></td><td><a class='link-one-self' title='Link to this declaration' href='../sockjs/index.html#SockJSServer'><i class='icon-link'></i></a><div class='signature'><span class='modifiers'>shared</span> <a class='link' href='../sockjs/SockJSServer.type.html' title='Go to io.vertx.ceylon.core.sockjs::SockJSServer'>SockJSServer</a></div><div class='description'><div class='doc section'><p>This is an implementation of the server side part of <a href="https://github.com/sockjs">SockJS</a></p>
<p>SockJS enables browsers to communicate with the server using a simple WebSocket-like api for sending
and receiving messages. Under the bonnet SockJS chooses to use one of several protocols depending on browser
capabilities and what appears to be working across the network.</p>
<p>Available protocols include:</p>
<ul>
<li><em>WebSockets</em></li>
<li><em>xhr-polling</em></li>
<li><em>xhr-streaming</em></li>
<li><em>json-polling</em></li>
<li><em>event-source</em></li>
<li><em>html-file</em></li>
</ul>
<p>This means, it should <em>just work</em> irrespective of what browser is being used, and whether there are nasty
things like proxies and load balancers between the client and the server.</p>
<p>For more detailed information on SockJS, see their website.</p>
<p>On the server side, you interact using instances of <a class='link' href='../sockjs/SockJSSocket.type.html' title='Go to io.vertx.ceylon.core.sockjs::SockJSSocket'>SockJSSocket</a> - this allows you to send data to the
client or receive data via the <a class='link' href='../sockjs/SockJSSocket.type.html#readStream' title='Go to io.vertx.ceylon.core.sockjs::SockJSSocket.readStream'>SockJSSocket.readStream</a> <a class='link' href='../stream/ReadStream.type.html#dataHandler' title='Go to io.vertx.ceylon.core.stream::ReadStream.dataHandler'>io.vertx.ceylon.core.stream::ReadStream.dataHandler</a>.</p>
<p>You can register multiple applications with the same SockJSServer, each using different path prefixes, each
application will have its own handler, and configuration.</p>
<p>Instances of this class are not thread-safe.</p>
</div></div></td></tr><tr><td id='SockJSSocket' nowrap><i class='icon-class'></i><a class='link-discreet' href='../sockjs/SockJSSocket.type.html'>SockJSSocket</a></td><td><a class='link-one-self' title='Link to this declaration' href='../sockjs/index.html#SockJSSocket'><i class='icon-link'></i></a><div class='signature'><span class='modifiers'>shared</span> <a class='link' href='../sockjs/SockJSSocket.type.html' title='Go to io.vertx.ceylon.core.sockjs::SockJSSocket'>SockJSSocket</a></div><div class='description'><div class='doc section'><p>You interact with SockJS clients through instances of SockJS socket.</p>
<p>The API is very similar to <a class='link' href='../http/WebSocket.type.html' title='Go to io.vertx.ceylon.core.http::WebSocket'>io.vertx.ceylon.core.http::WebSocket</a>.
It provides access to both <a class='link' href='../sockjs/SockJSSocket.type.html#readStream' title='Go to io.vertx.ceylon.core.sockjs::SockJSSocket.readStream'>SockJSSocket.readStream</a> and <a class='link' href='../sockjs/SockJSSocket.type.html#writeStream' title='Go to io.vertx.ceylon.core.sockjs::SockJSSocket.writeStream'>SockJSSocket.writeStream</a> so it can be used with
<a class='link' href='../stream/Pump.type.html' title='Go to io.vertx.ceylon.core.stream::Pump'>io.vertx.ceylon.core.stream::Pump</a> to pump data with flow control.</p>
<p>Instances of this class are not thread-safe.</p>
</div></div></td></tr></tbody></table></div><script type='text/javascript'>var resourceBaseUrl = '../.resources/'</script><script type='text/javascript' src='../.resources/jquery-1.8.2.min.js'></script><script type='text/javascript' src='../.resources/bootstrap.min.js'></script><script type='text/javascript' src='../.resources/shCore.js'></script><script type='text/javascript' src='../.resources/shAutoloader.js'></script><script type='text/javascript' src='../.resources/shBrushCeylon.js'></script><script type='text/javascript' src='../.resources/index.js'></script><script type='text/javascript' src='../.resources/ceylondoc.js'></script><script type='text/javascript'>jQuery('html').keypress(function(evt){
  evt = evt || window.event;
  var keyCode = evt.keyCode || evt.which;
  if( !evt.ctrlKey && !evt.altKey ) {
    if (keyCode == 63) {
      $('#infoDropdown > .dropdown-toggle').click();
    }
    if(keyCode == 115){
      document.location = '../search.html';
    }
    if(keyCode == 99){
      document.location = '#section-classes';
    }
    if(keyCode == 112){
      document.location = 'index.html';
    }
    if(keyCode == 111){
      document.location = '../index.html';
    }
    if(keyCode == 105){
      document.location = '#section-interfaces';
    }
  }
});
enableInfoKeybordShortcut('\\?');
enableInfoKeybordShortcut('s');
enableInfoKeybordShortcut('c');
enableInfoKeybordShortcut('p');
enableInfoKeybordShortcut('o');
enableInfoKeybordShortcut('i');
</script></body></html>